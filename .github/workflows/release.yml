ã„”ã„›gitname: Release Build

# è§¸ç™¼æ¢ä»¶ï¼šç•¶å‰µå»ºtagæ™‚åŸ·è¡Œ
on:
  push:
    tags:
      - 'v*'  # åŒ¹é…æ‰€æœ‰ä»¥vé–‹é ­çš„tagï¼Œå¦‚ v1.0.0

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # æ­¥é©Ÿ1: æª¢å‡ºä»£ç¢¼
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ç²å–å®Œæ•´çš„gitæ­·å²
    
    # æ­¥é©Ÿ2: è¨­ç½®Node.jsç’°å¢ƒ
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    # æ­¥é©Ÿ3: å®‰è£ä¾è³´
    - name: Install dependencies
      run: npm ci
    
    # æ­¥é©Ÿ4: é‹è¡Œé¡žåž‹æª¢æŸ¥
    - name: Type check
      run: npm run type-check
    
    # æ­¥é©Ÿ5: æ§‹å»ºé …ç›®
    - name: Build project
      run: npm run build
    
    # æ­¥é©Ÿ6: é…ç½®Gitç”¨æˆ¶ä¿¡æ¯
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
    
    # æ­¥é©Ÿ7: ç²å–tagä¿¡æ¯
    - name: Get tag info
      id: tag_info
      run: |
        echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        echo "tag_message=$(git tag -l --format='%(contents:subject)' ${GITHUB_REF#refs/tags/})" >> $GITHUB_OUTPUT
    
    # æ­¥é©Ÿ8: åˆ‡æ›åˆ°releaseåˆ†æ”¯æˆ–å‰µå»ºæ–°çš„releaseåˆ†æ”¯
    - name: Switch to release branch
      run: |
        # æª¢æŸ¥releaseåˆ†æ”¯æ˜¯å¦å­˜åœ¨
        if git show-ref --verify --quiet refs/remotes/origin/release; then
          echo "Release branch exists, switching to it"
          git checkout -B release origin/release
          # æ¸…ç©ºreleaseåˆ†æ”¯çš„å…§å®¹ï¼Œä½†ä¿ç•™.gitç›®éŒ„
          git rm -rf . 2>/dev/null || true
        else
          echo "Release branch does not exist, creating it"
          git checkout --orphan release
          # æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶ï¼Œä½†å¿½ç•¥éŒ¯èª¤
          git rm -rf . 2>/dev/null || true
        fi
    
    # æ­¥é©Ÿ9: è¤‡è£½æ§‹å»ºæ–‡ä»¶åˆ°releaseåˆ†æ”¯
    - name: Copy build files
      run: |
        # å¾žä¸»åˆ†æ”¯è¤‡è£½æ§‹å»ºæ–‡ä»¶
        git checkout ${GITHUB_REF#refs/tags/} -- dist/
        git checkout ${GITHUB_REF#refs/tags/} -- index.html
        git checkout ${GITHUB_REF#refs/tags/} -- package.json
        git checkout ${GITHUB_REF#refs/tags/} -- README.md
        
        # ç¢ºä¿distç›®éŒ„å­˜åœ¨
        if [ ! -d "dist" ]; then
          echo "Build failed or dist directory not found"
          exit 1
        fi
    
    # æ­¥é©Ÿ10: å‰µå»ºç™¼å¸ƒèªªæ˜Žæ–‡ä»¶
    - name: Create release notes
      run: |
        cat > RELEASE_NOTES.md << EOF
        # Release ${GITHUB_REF#refs/tags/}
        
        **ç™¼å¸ƒæ™‚é–“**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        
        **Tagä¿¡æ¯**: ${{ steps.tag_info.outputs.tag_name }}
        
        **æäº¤ä¿¡æ¯**: ${{ steps.tag_info.outputs.tag_message }}
        
        ## æ§‹å»ºä¿¡æ¯
        - æ§‹å»ºæ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        - æ§‹å»ºç’°å¢ƒ: GitHub Actions (Ubuntu Latest)
        - Node.jsç‰ˆæœ¬: $(node --version)
        - NPMç‰ˆæœ¬: $(npm --version)
        
        ## æ–‡ä»¶çµæ§‹
        \`\`\`
        $(find dist -type f | head -20)
        \`\`\`
        
        ## éƒ¨ç½²èªªæ˜Ž
        æ­¤ç‰ˆæœ¬å·²æº–å‚™å¥½éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒã€‚
        
        ### æœ¬åœ°æ¸¬è©¦
        \`\`\`bash
        npm run preview
        \`\`\`
        EOF
    
    # æ­¥é©Ÿ11: æäº¤æ›´æ”¹
    - name: Commit changes
      run: |
        git add .
        git commit -m "Release ${GITHUB_REF#refs/tags/}

        - æ§‹å»ºæ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        - åŸºæ–¼tag: ${GITHUB_REF#refs/tags/}
        - æäº¤ä¿¡æ¯: ${{ steps.tag_info.outputs.tag_message }}"
    
    # æ­¥é©Ÿ12: æŽ¨é€åˆ°releaseåˆ†æ”¯
    - name: Push to release branch
      run: |
        git push origin release
    
    # æ­¥é©Ÿ13: å‰µå»ºGitHub Release
    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Release ${{ github.ref_name }}
        body: |
          ## éº»å°‡è¨ˆåˆ†å·¥å…· Release ${{ github.ref_name }}
          
          **ç™¼å¸ƒæ™‚é–“**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          ### ä¸»è¦åŠŸèƒ½
          - ðŸŽ® å¿«é€Ÿè¨˜éŒ„æ¯å±€éº»å°‡åˆ†æ•¸
          - ðŸ“Š å³æ™‚è¨ˆç®—çŽ©å®¶ç¸½åˆ†
          - ðŸ“ å®Œæ•´æ­·å²è¨˜éŒ„èˆ‡çµ±è¨ˆåˆ†æž
          - ðŸ’¾ æœ¬åœ°å„²å­˜ï¼Œè³‡æ–™ä¸éºå¤±
          - ðŸ“± æ‰‹æ©Ÿå„ªå…ˆè¨­è¨ˆï¼Œè§¸æŽ§å‹å–„
          
          ### éƒ¨ç½²ä¿¡æ¯
          - æ§‹å»ºåˆ†æ”¯: release
          - æ§‹å»ºç‹€æ…‹: âœ… æˆåŠŸ
          - æ§‹å»ºæ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          ### ä¸‹è¼‰
          æ§‹å»ºæ–‡ä»¶å·²æŽ¨é€åˆ° `release` åˆ†æ”¯ï¼Œå¯ç›´æŽ¥éƒ¨ç½²ä½¿ç”¨ã€‚
        draft: false
        prerelease: false
    
    # æ­¥é©Ÿ14: è¼¸å‡ºæ§‹å»ºä¿¡æ¯
    - name: Build summary
      run: |
        echo "ðŸŽ‰ æ§‹å»ºå®Œæˆï¼"
        echo "ðŸ“¦ Tag: ${GITHUB_REF#refs/tags/}"
        echo "ðŸŒ¿ Releaseåˆ†æ”¯: release"
        echo "ðŸ“ æ§‹å»ºæ–‡ä»¶: dist/"
        echo "ðŸ“‹ ç™¼å¸ƒèªªæ˜Ž: RELEASE_NOTES.md"
        echo ""
        echo "æ§‹å»ºæ–‡ä»¶åˆ—è¡¨:"
        find dist -type f | head -10
